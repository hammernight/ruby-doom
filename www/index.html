<html>
<head><title>Ruby-DOOM</title></head>
<body>

<hr>
<p><b>Status (12/8/03)</b>: Ruby-DOOM can read and write a wad file and make simple modifications (i.e., change the direction the player is facing).  Continuing to fill in the object model - next up, linedefs.
<p>Here's the <a href="http://rubyforge.org/projects/ruby-doom/">project page</a> and <a href="http://rubyforge.org/cgi-bin/viewcvs/cgi/viewcvs.cgi/ruby-doom/src/ruby/?cvsroot=ruby-doom#dirlist">the code</a>.

<hr>

<p>If you want to generate a DOOM map, you need to use a level editor and manually create the map, either from scratch, or from a template.  Although this works well for most map creation scenarious, it would be nifty if the maps could be generated programmatically.  This would allow maps to be generated for <a href="http://cougaar.org/">Cougaar</a> agent community visualization, or <a href="http://pmd.sf.net/">PMD</a> problem visualization, or from a floor plan. 

<p>Here's an example of what I'd like to be able to do:
<table>
<tr>
<td>
<pre>
level = Level.new(10,10)
level.add(Sector.new(0,0,2,2))
level.add(Sector.new(5,5,7,7))
level.spawn_point(1,1)
m = Map.new(level)
m.write_to_file("simple.wad")
</pre>
</td>
<td width=200 align=center>
<====>
</td>
<td>
<img src="samplemap.png"/>
</td>
</tr>
</table>
<hr>
<p><a name="wad"/>I'll try to document the wad file structure as I go.  Props go out to the many folks out there who have figured out this stuff before I did.  Hopefully I can summarize some of the important points here.
<p><b>Header</b> - a 12 byte sequence.  <font color="blue">80, 87, 65, 68, 11, 0, 0, 0, 212, 2, 0, 0, 0</font>
<ul>
<li>Bytes 0-3: WAD type - either PWAD or IWAD (characters).  <font color="blue">80, 87, 65, 68</font>
<li>Bytes 4-7: Number of lumps (<a href="#long">long integer</a>). <font color="blue">11, 0, 0, 0</font>
<li>Bytes 8-12: File offset to the beginning of the directory (long integer). <font color="blue">212, 2, 0, 0, 0</font>
</ul>
<p><b>Directory entries</b> - a series of 16 byte sequences.  <font color="blue">13, 0, 0, 0, 10, 0, 0, 0, 84, 72, 73, 78, 71, 83, 0, 0</font>
<ul>
<li>Bytes 0-3: The file offset to the start of the lump (long integer).  <font color="blue">13, 0, 0, 0</font>
<li>Bytes 4-7: Size of the lump (long integer).  <font color="blue">10, 0, 0, 0</font>
<li>Bytes 8-15: The name of the lump padded with zeros (characters).  <font color="blue">84, 72, 73, 78, 71, 83, 0, 0</font>
</ul>
<p><b>Lumps</b> - a bunch of different kinds of data of variable length.
<ul>
<li>THINGS - 10 byte sequence
<ul>
<li>Bytes 0-2: Location (x) (short) 
<li>Bytes 2-4: Location (y) (short)
<li>Bytes 4-6: Facing angle (short)
<li>Bytes 6-8: Type ID (short)
<li>Bytes 8-10: Flags (short)
</ul>

<li>LINEDEFS - 12 byte sequence
<ul>
<li>Bytes 0-2: Start VERTEX (short) 
<li>Bytes 2-4: End VERTEX (short)
<li>Bytes 4-6: Attributes (short)
<li>Bytes 6-8: Special effects type (short)
<li>Bytes 8-10: Tag (short)
<li>Bytes 10-12: Right SIDEDEF (short)
<li>Bytes 12-14: Left SIDEDEF (short)
</ul>

</ul>
<p>Here's a sample run from the current version of <code>doom.rb</code>:
<pre>
[tom@rubyforge ruby]$ ./doom.rb                                                                                                             105,2-4       19%
Reading WAD into memory
Done reading, building the object model
Object model built
The file ../../test_wads/simple.wad is a 900 byte patch WAD
It's got 11 lumps, the directory started at byte 724
Lump      Size
MAP01     0
THINGS    10
 - Player 1 at 224,65120 facing east
LINEDEFS  112
 - Linedef from 0 to 1; attribute flag is 1; special fx is 0
 - Linedef from 1 to 2; attribute flag is 1; special fx is 0
 - Linedef from 2 to 3; attribute flag is 1; special fx is 0
 - Linedef from 3 to 0; attribute flag is 1; special fx is 0
 - Linedef from 4 to 5; attribute flag is 1; special fx is 0
 - Linedef from 5 to 6; attribute flag is 1; special fx is 0
 - Linedef from 6 to 7; attribute flag is 1; special fx is 0
 - Linedef from 7 to 4; attribute flag is 1; special fx is 0
SIDEDEFS  240
VERTEXES  32
SEGS      96
SSECTORS  8
NODES     28
SECTORS   52
REJECT    1
BLOCKMAP  132
Writing WAD
Done
</pre>


<hr>
<ul>
<li><a name="long"/>All long integers in WAD files are 32 bit unsigned longs in little-endian format (shorts are unsigned, 16 bits, little-endian as well).  So the byte sequence <font color="blue">212 2 0 0</font> is really <font color="blue">0 0 2 212</font> which translates to <font color="blue">724</font> decimal.  I'm using the following Ruby snippet to do this transformation:
<pre>
bytes.pack("C4").unpack("V")[0]
</pre>
<p>Also, I'm a bit of a dolt, so I had to do this to understand this byte packing order.  <font color="blue">0 0 2 212</font> converted to binary is <code>00000000 00000000 00000010 11001010</code>.  So the <code>1</code> is in the <code>512</code> place, so <code>512 + 212 = 724</code>.
<p>

<li>Some notes from a fella on Slashdot - the WAD file builder only needs to generate the THINGS, LINEDEFS, SIDEDEFS, VERTEXES, AND SECTORS.  Everything else is generated by a <a href="http://doombsp.sf.net/">BSP node builder</a>.
</ul>

</body>
<html>
