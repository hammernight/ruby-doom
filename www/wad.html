<html>
<head><title>WAD file structure</title></head>
<body>
<p>Props go out to the many folks out there who have figured out this stuff before I did.  Hopefully I can summarize some of what I consider to be the important points here.
<p>Header - a 12 byte sequence.  <font color="blue">80, 87, 65, 68, 11, 0, 0, 0, 212, 2, 0, 0, 0</font>
<ul>
<li>Bytes 0-3: WAD type - either PWAD or IWAD (characters).  <font color="blue">80, 87, 65, 68</font>
<li>Bytes 4-7: Number of lumps (<a href="#long">long integer</a>). <font color="blue">11, 0, 0, 0</font>
<li>Bytes 8-12: File offset to the beginning of the directory (long integer). <font color="blue">212, 2, 0, 0, 0</font>
</ul>
<p>Directory entries - a series of 16 byte sequences.  <font color="blue">13, 0, 0, 0, 10, 0, 0, 0, 84, 72, 73, 78, 71, 83, 0, 0</font>
<ul>
<li>Bytes 0-3: The file offset to the start of the lump (long integer).  <font color="blue">13, 0, 0, 0</font>
<li>Bytes 4-7: Size of the lump (long integer).  <font color="blue">10, 0, 0, 0</font>
<li>Bytes 8-15: The name of the lump padded with zeros (characters).  <font color="blue">84, 72, 73, 78, 71, 83, 0, 0</font>
</ul>
<p>Lumps - a bunch of different kinds of data of variable length.
<p>Here's a sample run from the current version of <code>doom.rb</code>:
<pre>
[tom@hal ruby]$ ./doom.rb -f ../../test_wads/stepstep.wad
Reading WAD into memory
Done reading, building the object model
Object model built
The file ../../test_wads/stepstep.wad is a 59436 byte patch WAD
It's got 11 lumps
The directory starts at byte 59260
Lump      Size (bytes)   Starts at offset
MAP01     0              12
THINGS    1310           12
LINEDEFS  7042           1322
SIDEDEFS  22530          8364
VERTEXES  2080           30894
SEGS      10344          32974
SSECTORS  1080           43318
NODES     7532           44398
SECTORS   2782           51930
REJECT    1432           54712
BLOCKMAP  3116           56144
[tom@hal ruby]$
</pre>


<hr>
<ul>
<li><a name="#long"/>All long integers in WAD files are 32 bit unsigned longs in little-endian format.  So the byte sequence <font color="blue">212 2 0 0</font> is really <font color="blue">0 0 2 212</font> which translates to <font color="blue">724</font> decimal.  I'm using the following Ruby snippet to do this transformation:
<pre>
bytes.pack("C4").unpack("V")[0]
</pre>
<p>Also, I'm a bit of a dolt, so I had to do this to understand this byte packing order.  <font color="blue">0 0 2 212</font> converted to binary is <code>00000000 00000000 00000010 11001010</code>.  So the <code>1</code> is in the <code>512</code> place, so <code>512 + 212 = 724</code>.
<p>

<li>Some notes from a fella on Slashdot - the WAD file builder only needs to generate the THINGS, LINEDEFS, SIDEDEFS, VERTEXES, AND SECTORS.  Everything else is generated by a <a href="http://doombsp.sf.net/">BSP node builder</a>.
</ul>
</body>
</html>
